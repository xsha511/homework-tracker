<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂØíÂÅá‰Ωú‰∏ö‰ªªÂä°Ê∏ÖÂçï ¬∑ ‰∏äÊµ∑Ëµ´Ë¥§Â≠¶Ê†°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-gold: #d4a441;
            --color-gold-light: #f5e6c4;
            --color-gold-dark: #b8860b;
            --color-navy: #1a2a4a;
            --color-navy-light: #2d4263;
            --color-cream: #faf8f3;
            --color-cream-dark: #f0ebe0;
            --color-text: #2c3e50;
            --color-text-light: #5a6c7d;
            --color-border: #e8e4db;
            --color-success: #27ae60;
            --color-bronze: #cd7f32;
            --color-silver: #c0c0c0;
            --color-gold-medal: #ffd700;
            --font-display: 'Cormorant Garamond', 'Noto Serif SC', serif;
            --font-body: 'Source Sans 3', -apple-system, 'PingFang SC', sans-serif;
            --font-chinese: 'Noto Serif SC', 'Songti SC', serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-body);
            background: var(--color-cream);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-navy-light) 100%);
            padding: 20px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-link {
            color: var(--color-gold-light);
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .back-link:hover { color: var(--color-gold); }

        .header-title {
            font-family: var(--font-chinese);
            color: white;
            font-size: 22px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sync-status {
            font-size: 12px;
            color: var(--color-gold-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .view-toggle {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: var(--color-gold);
            color: var(--color-navy);
            font-weight: 600;
        }

        /* Stats Bar */
        .stats-bar {
            background: white;
            border-bottom: 1px solid var(--color-border);
            padding: 25px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stats-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 200px 1fr 280px;
            gap: 40px;
            align-items: center;
        }

        /* Progress Ring */
        .progress-ring-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--color-cream-dark);
            stroke-width: 10;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--color-gold);
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percent {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-navy);
            font-family: var(--font-display);
        }

        .progress-label {
            font-size: 11px;
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Level & Streak */
        .level-streak {
            display: flex;
            gap: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--color-cream) 0%, white 100%);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 15px 25px;
            text-align: center;
            min-width: 120px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-navy);
            font-family: var(--font-display);
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-light);
            margin-top: 2px;
        }

        .level-title {
            font-size: 13px;
            color: var(--color-gold-dark);
            font-weight: 600;
            margin-top: 5px;
        }

        /* Badges Preview */
        .badges-preview {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .badges-title {
            font-size: 12px;
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .badges-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge-mini {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            position: relative;
            transition: transform 0.3s;
            cursor: pointer;
        }

        .badge-mini:hover {
            transform: scale(1.2);
        }

        .badge-mini.locked {
            background: var(--color-cream-dark);
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .badge-mini.bronze { background: linear-gradient(135deg, #cd7f32 0%, #b8860b 100%); }
        .badge-mini.silver { background: linear-gradient(135deg, #e8e8e8 0%, #c0c0c0 100%); }
        .badge-mini.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .badge-stars {
            position: absolute;
            bottom: -2px;
            right: -2px;
            font-size: 10px;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Subject View */
        .subject-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
        }

        .subject-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .subject-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }

        .subject-header {
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
        }

        .subject-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .subject-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .subject-icon.english { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .subject-icon.chinese { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); }
        .subject-icon.math { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .subject-icon.physics { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .subject-icon.chemistry { background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%); }
        .subject-icon.biology { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
        .subject-icon.economics { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .subject-icon.geography { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }

        .subject-name {
            font-family: var(--font-chinese);
            font-size: 18px;
            font-weight: 600;
            color: var(--color-navy);
        }

        .subject-progress {
            text-align: right;
        }

        .subject-progress-bar {
            width: 100px;
            height: 6px;
            background: var(--color-cream-dark);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .subject-progress-fill {
            height: 100%;
            background: var(--color-gold);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .subject-progress-text {
            font-size: 12px;
            color: var(--color-text-light);
        }

        /* Task List */
        .task-list {
            padding: 15px 25px 25px;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--color-cream-dark);
            transition: background 0.3s;
        }

        .task-item:last-child { border-bottom: none; }

        .task-item:hover {
            background: var(--color-cream);
            margin: 0 -25px;
            padding-left: 25px;
            padding-right: 25px;
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--color-border);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .task-checkbox:hover {
            border-color: var(--color-gold);
        }

        .task-checkbox.checked {
            background: var(--color-success);
            border-color: var(--color-success);
        }

        .task-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-size: 14px;
            color: var(--color-text);
            transition: all 0.3s;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: var(--color-text-light);
        }

        .task-meta {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }

        .task-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .task-tag.required {
            background: #ffebee;
            color: #c62828;
        }

        .task-tag.optional {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .task-tag.chapter {
            background: var(--color-cream-dark);
            color: var(--color-text-light);
        }

        /* Day View */
        .day-view {
            display: none;
        }

        .day-view.active {
            display: block;
        }

        .subject-view.active {
            display: grid;
        }

        .subject-view:not(.active) {
            display: none;
        }

        .day-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .day-nav-btn {
            background: var(--color-navy);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .day-nav-btn:hover {
            background: var(--color-navy-light);
        }

        .day-nav-current {
            font-family: var(--font-chinese);
            font-size: 18px;
            font-weight: 600;
            color: var(--color-navy);
        }

        .day-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
        }

        .day-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            min-height: 200px;
            transition: all 0.3s;
        }

        .day-card.drag-over {
            box-shadow: 0 0 0 3px var(--color-gold);
            transform: scale(1.02);
        }

        .day-card.today {
            box-shadow: 0 0 0 2px var(--color-gold);
        }

        .day-header {
            background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-navy-light) 100%);
            padding: 10px 15px;
            color: white;
            text-align: center;
        }

        .day-card.today .day-header {
            background: linear-gradient(135deg, var(--color-gold) 0%, var(--color-gold-dark) 100%);
            color: var(--color-navy);
        }

        .day-date {
            font-size: 22px;
            font-weight: 700;
            font-family: var(--font-display);
        }

        .day-weekday {
            font-size: 11px;
            opacity: 0.9;
        }

        .day-tasks {
            padding: 10px;
            min-height: 150px;
        }

        .day-task {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            margin-bottom: 6px;
            background: var(--color-cream);
            border-radius: 6px;
            font-size: 12px;
            cursor: grab;
            transition: all 0.2s;
        }

        .day-task:hover {
            background: var(--color-cream-dark);
        }

        .day-task.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .day-task.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .day-task.selected {
            background: var(--color-gold-light);
            box-shadow: 0 0 0 2px var(--color-gold);
        }

        .day-task.optional-task {
            border-left: 3px solid var(--color-success);
        }

        .day-task-subject {
            font-size: 14px;
        }

        .day-task-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .day-task-tag {
            font-size: 9px;
            padding: 1px 5px;
            border-radius: 3px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .day-task-tag.required {
            background: #ffebee;
            color: #c62828;
        }

        .day-task-tag.optional {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .day-card.can-drop {
            cursor: pointer;
        }

        .day-card.can-drop:hover {
            box-shadow: 0 0 0 2px var(--color-gold);
        }

        .unassigned-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        }

        .unassigned-title {
            font-family: var(--font-chinese);
            font-size: 16px;
            font-weight: 600;
            color: var(--color-navy);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .unassigned-count {
            background: var(--color-gold);
            color: var(--color-navy);
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
        }

        .unassigned-tasks {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
            padding: 10px;
            background: var(--color-cream);
            border-radius: 8px;
        }

        .unassigned-tasks.drag-over {
            background: var(--color-gold-light);
        }

        @media (max-width: 1200px) {
            .day-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 800px) {
            .day-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        }

        .week-task {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-cream-dark);
            font-size: 13px;
        }

        .week-task:last-child { border-bottom: none; }

        .week-task-subject {
            font-size: 16px;
        }

        /* Achievement Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .achievement-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .achievement-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            margin: 0 auto 20px;
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
        }

        .achievement-title {
            font-family: var(--font-chinese);
            font-size: 24px;
            color: var(--color-navy);
            margin-bottom: 10px;
        }

        .achievement-desc {
            color: var(--color-text-light);
            margin-bottom: 25px;
        }

        .achievement-close {
            background: var(--color-gold);
            color: var(--color-navy);
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .achievement-close:hover {
            transform: scale(1.05);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .level-streak {
                justify-content: center;
            }

            .badges-preview {
                align-items: center;
            }

            .badges-row {
                justify-content: center;
            }
        }

        @media (max-width: 900px) {
            .week-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .subject-view {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .week-container {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 15px;
            }
        }

        /* Confetti effect */
        .confetti {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="index.html" class="back-link">‚Üê ËøîÂõûÂ§ßÁ§ºÂåÖ</a>
                <h1 class="header-title">ÂØíÂÅá‰Ωú‰∏ö‰ªªÂä°Ê∏ÖÂçï</h1>
            </div>
            <div class="header-right">
                <div class="sync-status">
                    <span class="sync-dot"></span>
                    <span id="syncText">ÂÆûÊó∂ÂêåÊ≠•‰∏≠</span>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="subject">ÊåâÂ≠¶Áßë</button>
                    <button class="view-btn" data-view="day">ÊåâÂ§©ËÆ°Âàí</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stats-content">
            <!-- Progress Ring -->
            <div class="progress-ring-container">
                <div class="progress-ring">
                    <svg width="120" height="120">
                        <circle class="progress-ring-bg" cx="60" cy="60" r="50"/>
                        <circle class="progress-ring-fill" cx="60" cy="60" r="50"
                                stroke-dasharray="314" stroke-dashoffset="314" id="progressRing"/>
                    </svg>
                    <div class="progress-ring-text">
                        <div class="progress-percent" id="totalPercent">0%</div>
                        <div class="progress-label">ÊÄªËøõÂ∫¶</div>
                    </div>
                </div>
            </div>

            <!-- Level & Streak -->
            <div class="level-streak">
                <div class="stat-card">
                    <div class="stat-value" id="levelValue">1</div>
                    <div class="stat-label">ÂΩìÂâçÁ≠âÁ∫ß</div>
                    <div class="level-title" id="levelTitle">Â≠¶‰π†Êñ∞Êâã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="streakValue">0</div>
                    <div class="stat-label">ËøûÁª≠ÊâìÂç°</div>
                    <div class="level-title">Â§©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completedValue">0</div>
                    <div class="stat-label">Â∑≤ÂÆåÊàê</div>
                    <div class="level-title" id="totalTasks">/ 0 È°π</div>
                </div>
            </div>

            <!-- Badges Preview -->
            <div class="badges-preview">
                <div class="badges-title">ÊàêÂ∞±ÂæΩÁ´†</div>
                <div class="badges-row" id="badgesRow">
                    <!-- Badges will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Subject View -->
        <div class="subject-view active" id="subjectView">
            <!-- Subject cards will be inserted here -->
        </div>

        <!-- Day View -->
        <div class="day-view" id="dayView">
            <div class="day-nav">
                <button class="day-nav-btn" onclick="changeWeek(-1)">‚Üê ‰∏ä‰∏ÄÂë®</button>
                <span class="day-nav-current" id="currentWeekLabel">Á¨¨1Âë®</span>
                <button class="day-nav-btn" onclick="changeWeek(1)">‰∏ã‰∏ÄÂë® ‚Üí</button>
            </div>
            <div class="day-container" id="dayContainer">
                <!-- Day cards will be inserted here -->
            </div>
            <div class="unassigned-panel">
                <div class="unassigned-title">
                    üìã ÂæÖÂàÜÈÖç‰ªªÂä° <span class="unassigned-count" id="unassignedCount">0</span>
                </div>
                <div class="unassigned-tasks" id="unassignedTasks">
                    <!-- Unassigned tasks will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Achievement Modal -->
    <div class="modal-overlay" id="achievementModal">
        <div class="achievement-modal">
            <div class="achievement-icon" id="achievementIcon">üéØ</div>
            <h2 class="achievement-title" id="achievementTitle">ÊàêÂ∞±Ëß£ÈîÅÔºÅ</h2>
            <p class="achievement-desc" id="achievementDesc">ÊÅ≠Âñú‰Ω†Ëé∑Âæó‰∫ÜÊñ∞ÊàêÂ∞±ÔºÅ</p>
            <button class="achievement-close" onclick="closeAchievement()">Â§™Ê£í‰∫ÜÔºÅ</button>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://kaliqpyebqxjxbxggdyp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthbGlxcHllYnF4anhieGdnZHlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNTY1NDYsImV4cCI6MjA4NDYzMjU0Nn0.dnLCowhw12oatyMb6CF2YvRyDxw31G2ap89SJLGb9po';

        // ÂÆâÂÖ®ÂàõÂª∫SupabaseÂÆ¢Êà∑Á´ØÔºàÂ¶ÇÊûúSDKÂä†ËΩΩÂ§±Ë¥•Âàô‰∏∫nullÔºâ
        let supabase = null;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch (e) {
            console.log('Supabase SDK not available');
        }

        // Generate or get user ID
        let userId = localStorage.getItem('homework_user_id');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('homework_user_id', userId);
        }

        // Task Data - All homework tasks from the PDF documents with detailed descriptions
        const tasks = [
            // English - Ëã±ËØ≠
            { id: 'en_read_book', subject: 'english', title: 'ÈòÖËØª„ÄäThe Secret Garden„Äã', required: true, chapter: 'ÈòÖËØª', week: 1,
              detail: 'ÂÆåÊï¥ÈòÖËØªËã±ÊñáÂéüÁâà„ÄäÁßòÂØÜËä±Âõ≠„ÄãÔºåÁêÜËß£ÊïÖ‰∫ãÊÉÖËäÇÔºåÁßØÁ¥ØÁîüËØç' },
            { id: 'en_vocab_1', subject: 'english', title: 'Ëã±ËØ≠ËØçÊ±á Part 1', required: true, chapter: 'ËØçÊ±á', week: 1,
              detail: 'ËÉåËØµËØçÊ±áË°®A-MÈÉ®ÂàÜÔºåÊØèÂ§©20‰∏™ÂçïËØçÔºåÂÅöÂà∞‰ºöËØª‰ºöÂÜô‰ºöÁî®' },
            { id: 'en_vocab_2', subject: 'english', title: 'Ëã±ËØ≠ËØçÊ±á Part 2', required: true, chapter: 'ËØçÊ±á', week: 2,
              detail: 'ËÉåËØµËØçÊ±áË°®N-ZÈÉ®ÂàÜÔºåÂ§ç‰π†Â∑©Âõ∫Part 1' },
            { id: 'en_diary_1', subject: 'english', title: 'Ëã±ÊñáÊó•ËÆ∞ #1', required: true, chapter: 'ÂÜô‰Ωú', week: 1,
              detail: 'Áî®Ëã±ÊñáÂÜô‰∏ÄÁØáÊó•ËÆ∞Ôºå100-150ËØçÔºåËÆ∞ÂΩïÂØíÂÅáÁîüÊ¥ª' },
            { id: 'en_diary_2', subject: 'english', title: 'Ëã±ÊñáÊó•ËÆ∞ #2', required: true, chapter: 'ÂÜô‰Ωú', week: 2,
              detail: 'Á¨¨‰∫åÁØáËã±ÊñáÊó•ËÆ∞ÔºåÂ∞ùËØï‰ΩøÁî®Êñ∞Â≠¶ÁöÑËØçÊ±á' },
            { id: 'en_diary_3', subject: 'english', title: 'Ëã±ÊñáÊó•ËÆ∞ #3', required: true, chapter: 'ÂÜô‰Ωú', week: 3,
              detail: 'Á¨¨‰∏âÁØáËã±ÊñáÊó•ËÆ∞ÔºåÊ≥®ÊÑèËØ≠Ê≥ïÂíåÂè•ÂºèÂ§öÊ†∑ÊÄß' },
            { id: 'en_poster', subject: 'english', title: '„ÄäÁßòÂØÜËä±Âõ≠„ÄãÊµ∑Êä•', required: true, chapter: 'Âàõ‰Ωú', week: 3,
              detail: '‰∏∫„ÄäÁßòÂØÜËä±Âõ≠„ÄãËÆæËÆ°‰∏ÄÂº†Ëã±ÊñáÊµ∑Êä•ÔºåÂåÖÂê´‰π¶Âêç„ÄÅ‰∏ªËßí„ÄÅÊé®ËçêËØ≠' },
            { id: 'en_video', subject: 'english', title: 'Ëã±ÊñáËá™Êàë‰ªãÁªçËßÜÈ¢ë', required: false, chapter: 'Âè£ËØ≠', week: 4,
              detail: '„ÄêÈÄâÂÅö„ÄëÂΩïÂà∂1-2ÂàÜÈíüËã±ÊñáËá™Êàë‰ªãÁªçËßÜÈ¢ë' },

            // Chinese - ‰∏≠Êñá
            { id: 'cn_read_book', subject: 'chinese', title: 'ÈòÖËØª„ÄäÂëºÂÖ∞Ê≤≥‰º†„Äã', required: true, chapter: 'ÈòÖËØª', week: 1,
              detail: 'ÂÆåÊï¥ÈòÖËØªËêßÁ∫¢ÁöÑ„ÄäÂëºÂÖ∞Ê≤≥‰º†„ÄãÔºå‰Ωì‰ºö‰ΩúËÄÖÂØπÊïÖ‰π°ÁöÑÊÉÖÊÑü' },
            { id: 'cn_letter', subject: 'chinese', title: 'ÁªôËêßÁ∫¢ÂÜô‰ø°', required: true, chapter: 'ÂÜô‰Ωú', week: 3,
              detail: 'ËØªÂÆå„ÄäÂëºÂÖ∞Ê≤≥‰º†„ÄãÂêéÔºåÁªôËêßÁ∫¢ÂÜô‰∏ÄÂ∞Å‰ø°Ôºå800Â≠ó‰ª•‰∏äÔºåË°®Ëææ‰Ω†ÁöÑÊÑüÂèó' },
            { id: 'cn_calligraphy_1', subject: 'chinese', title: '‰π¶Ê≥ïÁªÉ‰π† Á¨¨1Âë®', required: true, chapter: '‰π¶Ê≥ï', week: 1,
              detail: 'ÊØèÂ§©ÁªÉ‰π†Á°¨Á¨î‰π¶Ê≥ï15-20ÂàÜÈíüÔºå‰∏¥ÊëπÂ≠óÂ∏ñ' },
            { id: 'cn_calligraphy_2', subject: 'chinese', title: '‰π¶Ê≥ïÁªÉ‰π† Á¨¨2Âë®', required: true, chapter: '‰π¶Ê≥ï', week: 2,
              detail: 'ÁªßÁª≠‰π¶Ê≥ïÁªÉ‰π†ÔºåÊ≥®ÊÑèÁ¨îÁîªÈ°∫Â∫èÂíåÁªìÊûÑ' },
            { id: 'cn_calligraphy_3', subject: 'chinese', title: '‰π¶Ê≥ïÁªÉ‰π† Á¨¨3Âë®', required: true, chapter: '‰π¶Ê≥ï', week: 3,
              detail: '‰π¶Ê≥ïÁªÉ‰π†ÔºåÂ∞ùËØïÊèêÈ´ò‰π¶ÂÜôÈÄüÂ∫¶‰øùÊåÅÂ∑•Êï¥' },
            { id: 'cn_calligraphy_4', subject: 'chinese', title: '‰π¶Ê≥ïÁªÉ‰π† Á¨¨4Âë®', required: true, chapter: '‰π¶Ê≥ï', week: 4,
              detail: 'ÂÆåÊàê‰π¶Ê≥ï‰ΩúÂìÅ‰∏ÄÂπÖÔºåÊãçÁÖß‰øùÂ≠ò' },
            { id: 'cn_extra_read', subject: 'chinese', title: '‰∏≠ÊñáÊãìÂ±ïÈòÖËØª', required: false, chapter: 'ÊãìÂ±ï', week: 4,
              detail: '„ÄêÈÄâÂÅö„ÄëÂÜçËØª‰∏ÄÊú¨‰∏≠ÊñáÊñáÂ≠¶‰ΩúÂìÅ' },

            // Math - Êï∞Â≠¶
            { id: 'math_calculator', subject: 'math', title: 'ÂáÜÂ§áÁßëÂ≠¶ËÆ°ÁÆóÂô®', required: true, chapter: 'ÂáÜÂ§á', week: 1,
              detail: 'Ë¥≠‰π∞IGCSEËÆ§ÂèØÁöÑÁßëÂ≠¶ËÆ°ÁÆóÂô®ÔºåÂ≠¶‰ºöÂü∫Êú¨Êìç‰ΩúÔºöÂàÜÊï∞„ÄÅÊ†πÂè∑„ÄÅÂπÇËøêÁÆó' },
            { id: 'math_unit1_1', subject: 'math', title: 'Unit 1 È¢Ñ‰π† 1.1-1.3', required: true, chapter: 'Unit 1', week: 1,
              detail: 'È¢Ñ‰π†Êï∞Â≠¶ÊïôÊùê1.1-1.3ËäÇÔºåÂÅöËØæÂêé‰æãÈ¢òÔºåÊ†áÊ≥®‰∏çÊáÇÁöÑÂú∞Êñπ' },
            { id: 'math_unit1_2', subject: 'math', title: 'Unit 1 È¢Ñ‰π† 1.4-1.6', required: true, chapter: 'Unit 1', week: 2,
              detail: 'È¢Ñ‰π†1.4-1.6ËäÇÔºåÈáçÁÇπÁêÜËß£Ê¶ÇÂøµÂíåÂÖ¨ÂºèÊé®ÂØº' },
            { id: 'math_unit1_3', subject: 'math', title: 'Unit 1 È¢Ñ‰π† 1.7-1.9', required: true, chapter: 'Unit 1', week: 2,
              detail: 'ÂÆåÊàêUnit 1È¢Ñ‰π†ÔºåÂ∞ùËØïÂÅöÁ´†ËäÇÊÄªÁªì' },
            { id: 'math_vocab', subject: 'math', title: 'Êï∞Â≠¶Ëã±ÊñáËØçÊ±á', required: true, chapter: 'ËØçÊ±á', week: 3,
              detail: 'ËÉåËØµÊï∞Â≠¶‰∏ì‰∏öËã±ÊñáËØçÊ±áË°®ÔºåÂåÖÊã¨ËøêÁÆóÁ¨¶Âè∑„ÄÅÂõæÂΩ¢ÂêçÁß∞Á≠â' },
            { id: 'math_exercise_1', subject: 'math', title: 'Unit 1 ÁªÉ‰π† Set A', required: true, chapter: 'ÁªÉ‰π†', week: 3,
              detail: 'ÂÆåÊàêUnit 1ÁªÉ‰π†È¢òSet AÔºåÈîôÈ¢òÊï¥ÁêÜÂà∞ÈîôÈ¢òÊú¨' },
            { id: 'math_exercise_2', subject: 'math', title: 'Unit 1 ÁªÉ‰π† Set B', required: true, chapter: 'ÁªÉ‰π†', week: 4,
              detail: 'ÂÆåÊàêUnit 1ÁªÉ‰π†È¢òSet BÔºåÂØπÁÖßÁ≠îÊ°àËá™ÊàëÊâπÊîπ' },
            { id: 'math_extra', subject: 'math', title: 'Êï∞Â≠¶ËØæÂ§ñËØªÁâ©', required: false, chapter: 'ÊãìÂ±ï', week: 4,
              detail: '„ÄêÈÄâÂÅö„ÄëÈòÖËØªÊé®ËçêÁöÑÊï∞Â≠¶ËØæÂ§ñËØªÁâ©' },

            // Physics - Áâ©ÁêÜ
            { id: 'phy_syllabus', subject: 'physics', title: '‰∫ÜËß£Áâ©ÁêÜÂ§ßÁ∫≤', required: true, chapter: 'Â§ßÁ∫≤', week: 1,
              detail: 'ÈòÖËØªIGCSE Combined ScienceÁâ©ÁêÜÈÉ®ÂàÜÂ§ßÁ∫≤Ôºå‰∫ÜËß£Â≠¶‰π†ÂÜÖÂÆπÂíåËÄÉËØïË¶ÅÊ±Ç' },
            { id: 'phy_vocab_1', subject: 'physics', title: 'Áâ©ÁêÜËØçÊ±á Part 1', required: true, chapter: 'ËØçÊ±á', week: 2,
              detail: 'ËÉåËØµÁâ©ÁêÜËã±ÊñáËØçÊ±áÁ¨¨‰∏ÄÈÉ®ÂàÜÔºåÂåÖÊã¨ÂäõÂ≠¶Âü∫Êú¨ÊúØËØ≠' },
            { id: 'phy_vocab_2', subject: 'physics', title: 'Áâ©ÁêÜËØçÊ±á Part 2', required: true, chapter: 'ËØçÊ±á', week: 3,
              detail: 'ËÉåËØµÁâ©ÁêÜËã±ÊñáËØçÊ±áÁ¨¨‰∫åÈÉ®ÂàÜÔºåÂåÖÊã¨ÁîµÂ≠¶„ÄÅÁÉ≠Â≠¶ÊúØËØ≠' },
            { id: 'phy_preview', subject: 'physics', title: 'È¢Ñ‰π†Áâ©ÁêÜÁ¨¨1Á´†', required: true, chapter: 'È¢Ñ‰π†', week: 2,
              detail: 'È¢Ñ‰π†Áâ©ÁêÜÊïôÊùêÁ¨¨1Á´†ÔºåÁêÜËß£Âü∫Êú¨Áâ©ÁêÜÈáèÂíåÂçï‰Ωç' },
            { id: 'phy_video', subject: 'physics', title: 'Áâ©ÁêÜÁßëÊôÆËßÜÈ¢ë', required: false, chapter: 'ÊãìÂ±ï', week: 4,
              detail: '„ÄêÈÄâÂÅö„ÄëËßÇÁúãÊé®ËçêÁöÑÁâ©ÁêÜÁßëÊôÆËßÜÈ¢ë' },

            // Chemistry - ÂåñÂ≠¶
            { id: 'chem_syllabus', subject: 'chemistry', title: '‰∫ÜËß£ÂåñÂ≠¶Â§ßÁ∫≤', required: true, chapter: 'Â§ßÁ∫≤', week: 1,
              detail: 'ÈòÖËØªIGCSEÂåñÂ≠¶Â§ßÁ∫≤Ôºå‰∫ÜËß£Chapter 1-2ÁöÑÂ≠¶‰π†ÁõÆÊ†á' },
            { id: 'chem_vocab', subject: 'chemistry', title: 'ÂåñÂ≠¶Ëã±ÊñáËØçÊ±á', required: true, chapter: 'ËØçÊ±á', week: 2,
              detail: 'ËÉåËØµChapter 1-2ÁöÑÂåñÂ≠¶ËØçÊ±áÂíåÂÆö‰πâ' },
            { id: 'chem_ch1', subject: 'chemistry', title: 'Ch1 Áâ©Ë¥®ÁöÑÁä∂ÊÄÅ', required: true, chapter: 'Ch1', week: 2,
              detail: 'È¢Ñ‰π†Chapter 1ÔºöÂõ∫Ê∂≤Ê∞î‰∏âÊÄÅ„ÄÅÁ≤íÂ≠êÁêÜËÆ∫„ÄÅÁä∂ÊÄÅÂèòÂåñ' },
            { id: 'chem_ch2', subject: 'chemistry', title: 'Ch2 ÂéüÂ≠êÁªìÊûÑ', required: true, chapter: 'Ch2', week: 3,
              detail: 'È¢Ñ‰π†Chapter 2ÔºöÂéüÂ≠êÁªìÊûÑ„ÄÅË¥®Â≠ê‰∏≠Â≠êÁîµÂ≠ê„ÄÅÂÖÉÁ¥†Âë®ÊúüË°®' },
            { id: 'chem_exercise_1', subject: 'chemistry', title: 'Ch1 ÁªÉ‰π†È¢ò', required: true, chapter: 'ÁªÉ‰π†', week: 3,
              detail: 'ÂÆåÊàêChapter 1ÈÖçÂ•óÁªÉ‰π†ÂÜåÔºåÊ£ÄÈ™åÈ¢Ñ‰π†ÊïàÊûú' },
            { id: 'chem_exercise_2', subject: 'chemistry', title: 'Ch2 ÁªÉ‰π†È¢ò', required: true, chapter: 'ÁªÉ‰π†', week: 4,
              detail: 'ÂÆåÊàêChapter 2ÈÖçÂ•óÁªÉ‰π†ÂÜå' },
            { id: 'chem_video', subject: 'chemistry', title: 'ÂåñÂ≠¶ÂÆûÈ™åËßÜÈ¢ë', required: false, chapter: 'ÊãìÂ±ï', week: 4,
              detail: '„ÄêÈÄâÂÅö„ÄëËßÇÁúãÂåñÂ≠¶ÂÆûÈ™åÊºîÁ§∫ËßÜÈ¢ë' },

            // Biology - ÁîüÁâ©
            { id: 'bio_b1', subject: 'biology', title: 'B1 ÁîüÁâ©ÁöÑÁâπÂæÅ', required: true, chapter: 'B1', week: 1,
              detail: 'È¢Ñ‰π†B1ÔºöÁîüÂëΩÁöÑ‰∏ÉÂ§ßÁâπÂæÅMRS GRENÔºåÁêÜËß£ÊØè‰∏™ÁâπÂæÅÁöÑÂê´‰πâ' },
            { id: 'bio_b2', subject: 'biology', title: 'B2 ÁªÜËÉûÁªìÊûÑ', required: true, chapter: 'B2', week: 2,
              detail: 'È¢Ñ‰π†B2ÔºöÂä®Ê§çÁâ©ÁªÜËÉûÁªìÊûÑ„ÄÅÁªÜËÉûÂô®ÂäüËÉΩ„ÄÅÊòæÂæÆÈïú‰ΩøÁî®' },
            { id: 'bio_b3', subject: 'biology', title: 'B3 ÁîüÁâ©ÂàÜÂ≠ê', required: true, chapter: 'B3', week: 2,
              detail: 'È¢Ñ‰π†B3ÔºöÁ¢≥Ê∞¥ÂåñÂêàÁâ©„ÄÅËõãÁôΩË¥®„ÄÅËÑÇËÇ™„ÄÅÊ∞¥ÁöÑÂäüËÉΩ' },
            { id: 'bio_b4', subject: 'biology', title: 'B4 ÈÖ∂', required: true, chapter: 'B4', week: 3,
              detail: 'È¢Ñ‰π†B4ÔºöÈÖ∂ÁöÑÁâπÊÄß„ÄÅÂΩ±ÂìçÈÖ∂Ê¥ªÊÄßÁöÑÂõ†Á¥†' },
            { id: 'bio_b5', subject: 'biology', title: 'B5 Ê§çÁâ©Ëê•ÂÖª', required: true, chapter: 'B5', week: 3,
              detail: 'È¢Ñ‰π†B5ÔºöÂÖâÂêà‰ΩúÁî®ËøáÁ®ã„ÄÅÂè∂ÁâáÁªìÊûÑ' },
            { id: 'bio_vocab', subject: 'biology', title: 'ÁîüÁâ©Ëã±ÊñáËØçÊ±á', required: true, chapter: 'ËØçÊ±á', week: 2,
              detail: 'ËÉåËØµÁîüÁâ©ÂÖ≥ÈîÆËØçÊ±áKey WordsË°®' },
            { id: 'bio_exercise', subject: 'biology', title: 'B1-B5 ÁªÉ‰π†È¢ò', required: true, chapter: 'ÁªÉ‰π†', week: 4,
              detail: 'ÂÆåÊàêÁîüÁâ©ÁªÉ‰π†ÂÜåB1-B5ÁªºÂêàÁªÉ‰π†' },
            { id: 'bio_bbc', subject: 'biology', title: 'BBCÁîüÁâ©Á∫™ÂΩïÁâá', required: false, chapter: 'ÊãìÂ±ï', week: 4,
              detail: '„ÄêÈÄâÂÅö„ÄëËßÇÁúãBBCÁîüÁâ©Á∫™ÂΩïÁâáÔºåÂ¶Ç„ÄäÂú∞ÁêÉËÑâÂä®„Äã' },

            // Economics - ÁªèÊµé
            { id: 'econ_syllabus', subject: 'economics', title: '‰∫ÜËß£ÁªèÊµéÂ§ßÁ∫≤', required: true, chapter: 'Â§ßÁ∫≤', week: 1,
              detail: 'ÈòÖËØªIGCSEÁªèÊµéÂ≠¶Â§ßÁ∫≤Ôºå‰∫ÜËß£Section 1ÁöÑÂ≠¶‰π†ÁõÆÊ†á' },
            { id: 'econ_vocab', subject: 'economics', title: 'ÁªèÊµéÂ≠¶ÊúØËØ≠', required: true, chapter: 'ËØçÊ±á', week: 2,
              detail: 'ËÉåËØµSection 1ÁöÑÂÖ≥ÈîÆÊúØËØ≠Ôºöscarcity, opportunity cost, factors of productionÁ≠â' },
            { id: 'econ_s1_1', subject: 'economics', title: 'S1.1 ÁªèÊµéÂ≠¶Âü∫Êú¨ÈóÆÈ¢ò', required: true, chapter: 'S1', week: 2,
              detail: 'ÈòÖËØªSusan GrantÊïôÊùêSection 1.1ÔºåÁêÜËß£ÁªèÊµéÂ≠¶Á†îÁ©∂ÁöÑÂü∫Êú¨ÈóÆÈ¢ò' },
            { id: 'econ_s1_2', subject: 'economics', title: 'S1.2 Á®ÄÁº∫ÊÄß‰∏éÈÄâÊã©', required: true, chapter: 'S1', week: 3,
              detail: 'ÈòÖËØªSection 1.2ÔºåÁêÜËß£Á®ÄÁº∫ÊÄß„ÄÅÊú∫‰ºöÊàêÊú¨Ê¶ÇÂøµ' },
            { id: 'econ_mindmap', subject: 'economics', title: 'Section 1 ÊÄùÁª¥ÂØºÂõæ', required: true, chapter: 'ÊÄùÁª¥ÂØºÂõæ', week: 3,
              detail: 'ÁªòÂà∂Section 1ÁöÑÊÄùÁª¥ÂØºÂõæÔºåÊ¢≥ÁêÜÁü•ËØÜÊ°ÜÊû∂' },
            { id: 'econ_worksheet', subject: 'economics', title: 'ÁªèÊµéÂ≠¶Â∑•‰ΩúË°®', required: true, chapter: 'ÁªÉ‰π†', week: 4,
              detail: 'ÂÆåÊàêÁªèÊµéÂ≠¶ÈÖçÂ•óÂ∑•‰ΩúË°®ÁªÉ‰π†' },
            { id: 'econ_case', subject: 'economics', title: 'ÁªèÊµéÂ≠¶Ê°à‰æã', required: false, chapter: 'ÊãìÂ±ï', week: 4,
              detail: '„ÄêÈÄâÂÅö„ÄëÈòÖËØªÁªèÊµéÂ≠¶Ê°à‰æãÁ†îÁ©∂ÊùêÊñô' },

            // Geography - Âú∞ÁêÜ
            { id: 'geo_syllabus', subject: 'geography', title: '‰∫ÜËß£Âú∞ÁêÜÂ§ßÁ∫≤', required: true, chapter: 'Â§ßÁ∫≤', week: 1,
              detail: 'ÈòÖËØªIGCSEÂú∞ÁêÜÂ§ßÁ∫≤2027-2029ÁâàÔºå‰∫ÜËß£ËÄÉËØïÁªìÊûÑ' },
            { id: 'geo_vocab', subject: 'geography', title: 'Âú∞ÁêÜËã±ÊñáËØçÊ±á', required: true, chapter: 'ËØçÊ±á', week: 2,
              detail: 'ËÉåËØµÂú∞ÁêÜ‰∏ì‰∏öËØçÊ±áË°®ÔºåÂåÖÊã¨Âú∞ÂΩ¢„ÄÅÊ∞îÂÄôÁ≠âÊúØËØ≠' },
            { id: 'geo_preview', subject: 'geography', title: 'È¢Ñ‰π†Âú∞ÁêÜ1-2Á´†', required: true, chapter: 'È¢Ñ‰π†', week: 2,
              detail: 'È¢Ñ‰π†Âú∞ÁêÜÊïôÊùêÁ¨¨1-2Á´†Âü∫Á°ÄÂÜÖÂÆπ' },
            { id: 'geo_case_1', subject: 'geography', title: 'Ê°à‰æãÔºöÊ≤≥ÊµÅÂú∞Ë≤å', required: true, chapter: 'Ê°à‰æã', week: 3,
              detail: 'Â≠¶‰π†Ê≤≥ÊµÅÂú∞Ë≤åÊ°à‰æãÔºåÁêÜËß£‰æµËöÄÂíåÊ≤âÁßØ‰ΩúÁî®' },
            { id: 'geo_case_2', subject: 'geography', title: 'Ê°à‰æãÔºöÂüéÂ∏ÇÂåñ', required: true, chapter: 'Ê°à‰æã', week: 3,
              detail: 'Â≠¶‰π†ÂüéÂ∏ÇÂåñÊ°à‰æãÔºå‰∫ÜËß£ÂüéÂ∏ÇÂèëÂ±ï‰∏éÈóÆÈ¢ò' },
            { id: 'geo_questionnaire', subject: 'geography', title: 'Âú∞ÁêÜË∞ÉÊü•ÈóÆÂç∑', required: false, chapter: 'ÊãìÂ±ï', week: 4,
              detail: '„ÄêÈÄâÂÅö„ÄëÂÆåÊàêÂú∞ÁêÜË∞ÉÊü•ÈóÆÂç∑' },
        ];

        // Subject Configuration
        const subjects = {
            english: { name: 'Ëã±ËØ≠', icon: 'üá¨üáß', color: 'english' },
            chinese: { name: '‰∏≠Êñá', icon: 'üá®üá≥', color: 'chinese' },
            math: { name: 'Êï∞Â≠¶', icon: 'üî¢', color: 'math' },
            physics: { name: 'Áâ©ÁêÜ', icon: '‚ö°', color: 'physics' },
            chemistry: { name: 'ÂåñÂ≠¶', icon: 'üß™', color: 'chemistry' },
            biology: { name: 'ÁîüÁâ©', icon: 'üß¨', color: 'biology' },
            economics: { name: 'ÁªèÊµé', icon: 'üí∞', color: 'economics' },
            geography: { name: 'Âú∞ÁêÜ', icon: 'üåç', color: 'geography' }
        };

        // Badge Configuration
        const badges = [
            { id: 'early_bird', icon: 'üåÖ', name: 'Êó©Ëµ∑È∏ü', levels: [1, 10, 30], desc: ['ÂÆåÊàêÈ¶ñ‰∏™‰ªªÂä°', 'Á¥ØËÆ°ÂÆåÊàê10‰∏™', 'Á¥ØËÆ°ÂÆåÊàê30‰∏™'] },
            { id: 'all_rounder', icon: 'üìö', name: 'ÂÖ®ÁßëÊàòÂ£´', levels: [3, 6, 8], desc: ['3ÁßëÂêÑÂÆåÊàê1È°π', '6ÁßëÂêÑÂÆåÊàê1È°π', '8ÁßëÂêÑÂÆåÊàê1È°π'] },
            { id: 'fire', icon: 'üî•', name: 'ÂùöÊåÅ‰πãÁÅ´', levels: [3, 7, 14], desc: ['ËøûÁª≠ÊâìÂç°3Â§©', 'ËøûÁª≠ÊâìÂç°7Â§©', 'ËøûÁª≠ÊâìÂç°14Â§©'] },
            { id: 'efficient', icon: '‚ö°', name: 'ÊïàÁéáËææ‰∫∫', levels: [3, 5, 8], desc: ['ÂçïÊó•ÂÆåÊàê3È°π', 'ÂçïÊó•ÂÆåÊàê5È°π', 'ÂçïÊó•ÂÆåÊàê8È°π'] },
            { id: 'master', icon: 'üéØ', name: 'Â≠¶ÁßëÂ§ßÂ∏à', levels: [1, 3, 6], desc: ['1Áßë100%ÂÆåÊàê', '3Áßë100%ÂÆåÊàê', '6Áßë100%ÂÆåÊàê'] },
            { id: 'halfway', icon: 'üåü', name: 'ÂæÅÁ®ãËøáÂçä', levels: [25, 50, 75], desc: ['ÊÄªËøõÂ∫¶25%', 'ÊÄªËøõÂ∫¶50%', 'ÊÄªËøõÂ∫¶75%'] },
            { id: 'king', icon: 'üëë', name: 'ÂØíÂÅáÁéãËÄÖ', levels: [1, 2, 3], desc: ['ÂøÖÂÅöÂÖ®ÂÆåÊàê', 'ÂøÖÂÅö+50%ÈÄâÂÅö', '100%ÂÖ®ÂÆåÊàê'] },
            { id: 'explorer', icon: 'üé®', name: 'Êé¢Á¥¢ÂÖàÈîã', levels: [3, 6, 10], desc: ['ÂÆåÊàê3‰∏™ÈÄâÂÅö', 'ÂÆåÊàê6‰∏™ÈÄâÂÅö', 'ÂÆåÊàêÂÖ®ÈÉ®ÈÄâÂÅö'] }
        ];

        // Level Configuration
        const levels = [
            { level: 1, name: 'Â≠¶‰π†Êñ∞Êâã', required: 0 },
            { level: 2, name: 'Âã§Â•ãÂ≠¶Âæí', required: 10 },
            { level: 3, name: 'Áü•ËØÜÊé¢Á¥¢ËÄÖ', required: 25 },
            { level: 4, name: 'Â≠¶Èú∏ÂÄôÈÄâ‰∫∫', required: 45 },
            { level: 5, name: 'Ëµ´Ë¥§‰πãÊòü', required: tasks.length }
        ];

        // State
        let completedTasks = new Set();
        let userStats = {
            level: 1,
            streak_days: 0,
            last_active: null,
            badges: {},
            total_completed: 0
        };
        let todayCompleted = 0;

        // Initialize
        async function init() {
            // ÂÖàÊ∏≤ÊüìUIÔºåËÆ©Áî®Êà∑Á´ãÂç≥ÁúãÂà∞ÂÜÖÂÆπ
            renderSubjectView();
            renderWeekView();
            renderBadges();
            updateStats();
            setupViewToggle();

            // ÂÜçÂºÇÊ≠•Âä†ËΩΩ‰∫ëÁ´ØÊï∞ÊçÆ
            try {
                await loadProgress();
                // Âä†ËΩΩÂÆå‰∫ëÁ´ØÊï∞ÊçÆÂêéÊõ¥Êñ∞UI
                renderSubjectView();
                renderWeekView();
                renderBadges();
                updateStats();
                setupRealtimeSync();
            } catch (e) {
                console.log('Cloud sync not available, using local mode');
            }
        }

        // Load progress from Supabase
        async function loadProgress() {
            // Â¶ÇÊûúSupabase‰∏çÂèØÁî®ÔºåÁõ¥Êé•‰ªélocalStorageÂä†ËΩΩ
            if (!supabase) {
                const saved = localStorage.getItem('homework_progress');
                if (saved) completedTasks = new Set(JSON.parse(saved));
                return;
            }

            try {
                // Load task progress
                const { data: progressData, error: progressError } = await supabase
                    .from('progress')
                    .select('*')
                    .eq('user_id', userId);

                if (progressData) {
                    progressData.forEach(p => {
                        if (p.completed) completedTasks.add(p.task_id);
                    });
                }

                // Load user stats
                const { data: statsData, error: statsError } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', userId)
                    .single();

                if (statsData) {
                    userStats = statsData;
                    // Check streak
                    checkStreak();
                } else {
                    // Create new user stats
                    await supabase.from('user_stats').insert({
                        user_id: userId,
                        level: 1,
                        streak_days: 0,
                        badges: {},
                        total_completed: 0
                    });
                }
            } catch (e) {
                console.log('Loading from localStorage fallback');
                const saved = localStorage.getItem('homework_progress');
                if (saved) completedTasks = new Set(JSON.parse(saved));
            }
        }

        // Check and update streak
        function checkStreak() {
            const today = new Date().toISOString().split('T')[0];
            const lastActive = userStats.last_active;

            if (lastActive) {
                const lastDate = new Date(lastActive);
                const todayDate = new Date(today);
                const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));

                if (diffDays > 1) {
                    userStats.streak_days = 0;
                }
            }
        }

        // Setup realtime sync
        function setupRealtimeSync() {
            if (!supabase) return;

            supabase
                .channel('progress_changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'progress',
                    filter: `user_id=eq.${userId}`
                }, (payload) => {
                    if (payload.new && payload.new.completed) {
                        completedTasks.add(payload.new.task_id);
                    } else if (payload.new && !payload.new.completed) {
                        completedTasks.delete(payload.new.task_id);
                    }
                    updateUI();
                })
                .subscribe();
        }

        // Toggle task completion
        async function toggleTask(taskId) {
            const isCompleted = completedTasks.has(taskId);

            if (isCompleted) {
                completedTasks.delete(taskId);
            } else {
                completedTasks.add(taskId);
                todayCompleted++;
            }

            // Update UI immediately
            updateUI();

            // ‰øùÂ≠òÂà∞localStorageÔºàÊÄªÊòØ‰øùÂ≠òÔºâ
            localStorage.setItem('homework_progress', JSON.stringify([...completedTasks]));

            // ÂêåÊ≠•Âà∞SupabaseÔºàÂ¶ÇÊûúÂèØÁî®Ôºâ
            if (supabase) {
                try {
                    await supabase
                        .from('progress')
                        .upsert({
                            user_id: userId,
                            task_id: taskId,
                            completed: !isCompleted,
                            completed_at: !isCompleted ? new Date().toISOString() : null
                        }, { onConflict: 'user_id,task_id' });

                    if (!isCompleted) {
                        await updateUserStats();
                    }
                } catch (e) {
                    console.log('Cloud sync failed, saved locally');
                }
            }

            // Ê£ÄÊü•ÊàêÂ∞±
            if (!isCompleted) {
                checkAchievements();
            }
        }

        // Update user stats
        async function updateUserStats() {
            const today = new Date().toISOString().split('T')[0];
            const totalCompleted = completedTasks.size;

            // Calculate level
            let newLevel = 1;
            for (const l of levels) {
                if (totalCompleted >= l.required) newLevel = l.level;
            }

            // Update streak
            let newStreak = userStats.streak_days;
            if (userStats.last_active !== today) {
                const lastDate = userStats.last_active ? new Date(userStats.last_active) : null;
                const todayDate = new Date(today);
                if (lastDate) {
                    const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                    newStreak = diffDays === 1 ? userStats.streak_days + 1 : 1;
                } else {
                    newStreak = 1;
                }
            }

            userStats.level = newLevel;
            userStats.streak_days = newStreak;
            userStats.last_active = today;
            userStats.total_completed = totalCompleted;

            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('homework_stats', JSON.stringify(userStats));

            // ÂêåÊ≠•Âà∞SupabaseÔºàÂ¶ÇÊûúÂèØÁî®Ôºâ
            if (!supabase) return;

            try {
                await supabase.from('user_stats').upsert({
                    user_id: userId,
                    ...userStats,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'user_id' });
            } catch (e) {
                localStorage.setItem('homework_stats', JSON.stringify(userStats));
            }
        }

        // Check achievements
        function checkAchievements() {
            const totalCompleted = completedTasks.size;
            const totalRequired = tasks.filter(t => t.required).length;
            const totalOptional = tasks.filter(t => !t.required).length;
            const completedRequired = tasks.filter(t => t.required && completedTasks.has(t.id)).length;
            const completedOptional = tasks.filter(t => !t.required && completedTasks.has(t.id)).length;

            // Count subjects with completions
            const subjectCompletions = {};
            Object.keys(subjects).forEach(s => {
                const subjectTasks = tasks.filter(t => t.subject === s);
                const completed = subjectTasks.filter(t => completedTasks.has(t.id)).length;
                subjectCompletions[s] = {
                    completed,
                    total: subjectTasks.length,
                    percent: Math.round((completed / subjectTasks.length) * 100)
                };
            });

            const subjectsWithCompletions = Object.values(subjectCompletions).filter(s => s.completed > 0).length;
            const subjectsWith100 = Object.values(subjectCompletions).filter(s => s.percent === 100).length;
            const totalPercent = Math.round((totalCompleted / tasks.length) * 100);

            // Check each badge
            const oldBadges = { ...userStats.badges };

            // Early bird
            if (totalCompleted >= 30) userStats.badges.early_bird = 3;
            else if (totalCompleted >= 10) userStats.badges.early_bird = 2;
            else if (totalCompleted >= 1) userStats.badges.early_bird = 1;

            // All rounder
            if (subjectsWithCompletions >= 8) userStats.badges.all_rounder = 3;
            else if (subjectsWithCompletions >= 6) userStats.badges.all_rounder = 2;
            else if (subjectsWithCompletions >= 3) userStats.badges.all_rounder = 1;

            // Fire (streak)
            if (userStats.streak_days >= 14) userStats.badges.fire = 3;
            else if (userStats.streak_days >= 7) userStats.badges.fire = 2;
            else if (userStats.streak_days >= 3) userStats.badges.fire = 1;

            // Efficient
            if (todayCompleted >= 8) userStats.badges.efficient = 3;
            else if (todayCompleted >= 5) userStats.badges.efficient = 2;
            else if (todayCompleted >= 3) userStats.badges.efficient = 1;

            // Master
            if (subjectsWith100 >= 6) userStats.badges.master = 3;
            else if (subjectsWith100 >= 3) userStats.badges.master = 2;
            else if (subjectsWith100 >= 1) userStats.badges.master = 1;

            // Halfway
            if (totalPercent >= 75) userStats.badges.halfway = 3;
            else if (totalPercent >= 50) userStats.badges.halfway = 2;
            else if (totalPercent >= 25) userStats.badges.halfway = 1;

            // King
            if (totalCompleted === tasks.length) userStats.badges.king = 3;
            else if (completedRequired === totalRequired && completedOptional >= totalOptional / 2) userStats.badges.king = 2;
            else if (completedRequired === totalRequired) userStats.badges.king = 1;

            // Explorer
            if (completedOptional >= totalOptional) userStats.badges.explorer = 3;
            else if (completedOptional >= 6) userStats.badges.explorer = 2;
            else if (completedOptional >= 3) userStats.badges.explorer = 1;

            // Show achievement popup for new badges
            for (const [badgeId, level] of Object.entries(userStats.badges)) {
                if (!oldBadges[badgeId] || oldBadges[badgeId] < level) {
                    const badge = badges.find(b => b.id === badgeId);
                    showAchievement(badge, level);
                    break; // Only show one at a time
                }
            }

            renderBadges();
        }

        // Show achievement popup
        function showAchievement(badge, level) {
            const levelNames = ['', 'ÈìúÁâå', 'Èì∂Áâå', 'ÈáëÁâå'];
            const levelClasses = ['', 'bronze', 'silver', 'gold'];

            document.getElementById('achievementIcon').textContent = badge.icon;
            document.getElementById('achievementIcon').className = `achievement-icon ${levelClasses[level]}`;
            document.getElementById('achievementTitle').textContent = `${badge.name} ¬∑ ${levelNames[level]}`;
            document.getElementById('achievementDesc').textContent = badge.desc[level - 1];
            document.getElementById('achievementModal').classList.add('active');

            // Confetti effect
            createConfetti();
        }

        function closeAchievement() {
            document.getElementById('achievementModal').classList.remove('active');
        }

        // Create confetti effect
        function createConfetti() {
            const colors = ['#d4a441', '#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.cssText = `
                    left: ${Math.random() * 100}vw;
                    top: -10px;
                    width: ${Math.random() * 10 + 5}px;
                    height: ${Math.random() * 10 + 5}px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    animation: fall ${Math.random() * 3 + 2}s linear forwards;
                `;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }

            // Add fall animation if not exists
            if (!document.getElementById('confetti-style')) {
                const style = document.createElement('style');
                style.id = 'confetti-style';
                style.textContent = `
                    @keyframes fall {
                        to {
                            transform: translateY(100vh) rotate(720deg);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Render subject view
        function renderSubjectView() {
            const container = document.getElementById('subjectView');
            container.innerHTML = '';

            Object.entries(subjects).forEach(([key, subject]) => {
                const subjectTasks = tasks.filter(t => t.subject === key);
                const completed = subjectTasks.filter(t => completedTasks.has(t.id)).length;
                const percent = Math.round((completed / subjectTasks.length) * 100);

                const card = document.createElement('div');
                card.className = 'subject-card';
                card.innerHTML = `
                    <div class="subject-header">
                        <div class="subject-info">
                            <div class="subject-icon ${subject.color}">${subject.icon}</div>
                            <div class="subject-name">${subject.name}</div>
                        </div>
                        <div class="subject-progress">
                            <div class="subject-progress-bar">
                                <div class="subject-progress-fill" style="width: ${percent}%"></div>
                            </div>
                            <div class="subject-progress-text">${completed}/${subjectTasks.length} ÂÆåÊàê</div>
                        </div>
                    </div>
                    <div class="task-list">
                        ${subjectTasks.map(task => `
                            <div class="task-item ${completedTasks.has(task.id) ? 'completed' : ''}" data-id="${task.id}">
                                <div class="task-checkbox ${completedTasks.has(task.id) ? 'checked' : ''}" onclick="toggleTask('${task.id}')"></div>
                                <div class="task-content">
                                    <div class="task-title">${task.title}</div>
                                    <div class="task-meta">
                                        <span class="task-tag ${task.required ? 'required' : 'optional'}">${task.required ? 'ÂøÖÂÅö' : 'ÈÄâÂÅö'}</span>
                                        <span class="task-tag chapter">${task.chapter}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Êó•ËßÜÂõæÁõ∏ÂÖ≥
        const startDate = new Date('2026-01-20'); // ÂØíÂÅáÂºÄÂßãÊó•Êúü
        const endDate = new Date('2026-02-16');   // ÂØíÂÅáÁªìÊùüÊó•Êúü
        let currentWeekOffset = 0;
        let taskAssignments = {}; // { taskId: 'YYYY-MM-DD' }
        const weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
        let selectedTaskId = null; // ÂΩìÂâçÈÄâ‰∏≠ÁöÑ‰ªªÂä°

        // È¢ÑËÆæÁöÑÊØèÊó•ËÆ°ÂàíÔºàÂü∫‰∫éÂ≠¶‰π†ËßÑÂæãÂêàÁêÜÂàÜÈÖçÔºâ
        const defaultAssignments = {
            // Á¨¨1Âë® (1/20-1/26): ÂêØÂä®Âë® - ÁÜüÊÇâÂ§ßÁ∫≤„ÄÅÂºÄÂßãÈòÖËØª„ÄÅËØçÊ±áËµ∑Ê≠•
            'en_read_book': '2026-01-20',      // ÈòÖËØªÊòØÊåÅÁª≠‰ªªÂä°Ôºå‰ªéÁ¨¨‰∏ÄÂ§©ÂºÄÂßã
            'cn_read_book': '2026-01-20',      // ‰∏≠ÊñáÈòÖËØªÂêåÊ≠•ÂºÄÂßã
            'phy_syllabus': '2026-01-20',      // ‰∫ÜËß£Áâ©ÁêÜÂ§ßÁ∫≤
            'chem_syllabus': '2026-01-21',     // ‰∫ÜËß£ÂåñÂ≠¶Â§ßÁ∫≤
            'econ_syllabus': '2026-01-21',     // ‰∫ÜËß£ÁªèÊµéÂ§ßÁ∫≤
            'geo_syllabus': '2026-01-22',      // ‰∫ÜËß£Âú∞ÁêÜÂ§ßÁ∫≤
            'math_calculator': '2026-01-22',   // ÂáÜÂ§áËÆ°ÁÆóÂô®
            'bio_b1': '2026-01-23',            // ÁîüÁâ©B1È¢Ñ‰π†
            'math_unit1_1': '2026-01-23',      // Êï∞Â≠¶1.1-1.3
            'en_vocab_1': '2026-01-24',        // Ëã±ËØ≠ËØçÊ±áPart1
            'cn_calligraphy_1': '2026-01-24',  // ‰π¶Ê≥ïÁ¨¨1Âë®
            'en_diary_1': '2026-01-25',        // Ëã±ËØ≠Êó•ËÆ∞1

            // Á¨¨2Âë® (1/27-2/2): Ê∑±ÂÖ•Âë® - ÂêÑÁßëÈ¢Ñ‰π†„ÄÅËØçÊ±áÂä†Âº∫
            'math_unit1_2': '2026-01-27',      // Êï∞Â≠¶1.4-1.6
            'chem_vocab': '2026-01-27',        // ÂåñÂ≠¶ËØçÊ±á
            'phy_vocab_1': '2026-01-28',       // Áâ©ÁêÜËØçÊ±á1
            'chem_ch1': '2026-01-28',          // ÂåñÂ≠¶Ch1È¢Ñ‰π†
            'bio_b2': '2026-01-29',            // ÁîüÁâ©B2
            'bio_vocab': '2026-01-29',         // ÁîüÁâ©ËØçÊ±á
            'econ_vocab': '2026-01-30',        // ÁªèÊµéËØçÊ±á
            'econ_s1_1': '2026-01-30',         // ÁªèÊµéS1.1
            'geo_vocab': '2026-01-31',         // Âú∞ÁêÜËØçÊ±á
            'geo_preview': '2026-01-31',       // Âú∞ÁêÜÈ¢Ñ‰π†
            'math_unit1_3': '2026-02-01',      // Êï∞Â≠¶1.7-1.9
            'phy_preview': '2026-02-01',       // Áâ©ÁêÜÈ¢Ñ‰π†
            'en_vocab_2': '2026-02-02',        // Ëã±ËØ≠ËØçÊ±áPart2
            'cn_calligraphy_2': '2026-02-02',  // ‰π¶Ê≥ïÁ¨¨2Âë®
            'bio_b3': '2026-02-02',            // ÁîüÁâ©B3
            'en_diary_2': '2026-02-02',        // Ëã±ËØ≠Êó•ËÆ∞2

            // Á¨¨3Âë® (2/3-2/9): Âº∫ÂåñÂë® - ÁªÉ‰π†È¢ò„ÄÅÊ∑±Â∫¶Â≠¶‰π†
            'chem_ch2': '2026-02-03',          // ÂåñÂ≠¶Ch2
            'bio_b4': '2026-02-03',            // ÁîüÁâ©B4
            'econ_s1_2': '2026-02-04',         // ÁªèÊµéS1.2
            'phy_vocab_2': '2026-02-04',       // Áâ©ÁêÜËØçÊ±á2
            'bio_b5': '2026-02-05',            // ÁîüÁâ©B5
            'math_vocab': '2026-02-05',        // Êï∞Â≠¶ËØçÊ±á
            'geo_case_1': '2026-02-06',        // Âú∞ÁêÜÊ°à‰æã1
            'chem_exercise_1': '2026-02-06',   // ÂåñÂ≠¶ÁªÉ‰π†1
            'geo_case_2': '2026-02-07',        // Âú∞ÁêÜÊ°à‰æã2
            'econ_mindmap': '2026-02-07',      // ÁªèÊµéÊÄùÁª¥ÂØºÂõæ
            'math_exercise_1': '2026-02-08',   // Êï∞Â≠¶ÁªÉ‰π†A
            'en_poster': '2026-02-08',         // ÁßòÂØÜËä±Âõ≠Êµ∑Êä•
            'cn_letter': '2026-02-08',         // ÁªôËêßÁ∫¢ÂÜô‰ø°
            'cn_calligraphy_3': '2026-02-09',  // ‰π¶Ê≥ïÁ¨¨3Âë®
            'en_diary_3': '2026-02-09',        // Ëã±ËØ≠Êó•ËÆ∞3

            // Á¨¨4Âë® (2/10-2/16): Êî∂Â∞æÂë® - ÁªÉ‰π†È¢ò„ÄÅÈÄâÂÅö‰ªªÂä°
            'math_exercise_2': '2026-02-10',   // Êï∞Â≠¶ÁªÉ‰π†B
            'chem_exercise_2': '2026-02-10',   // ÂåñÂ≠¶ÁªÉ‰π†2
            'bio_exercise': '2026-02-11',      // ÁîüÁâ©ÁªºÂêàÁªÉ‰π†
            'econ_worksheet': '2026-02-11',    // ÁªèÊµéÂ∑•‰ΩúË°®
            'cn_calligraphy_4': '2026-02-12',  // ‰π¶Ê≥ïÁ¨¨4Âë®
            // ÈÄâÂÅö‰ªªÂä°ÊîæÂú®ÊúÄÂêéÂá†Â§©
            'en_video': '2026-02-13',          // ÈÄâÂÅöÔºöËã±ËØ≠ËßÜÈ¢ë
            'math_extra': '2026-02-13',        // ÈÄâÂÅöÔºöÊï∞Â≠¶ËØæÂ§ñËØª
            'phy_video': '2026-02-14',         // ÈÄâÂÅöÔºöÁâ©ÁêÜËßÜÈ¢ë
            'chem_video': '2026-02-14',        // ÈÄâÂÅöÔºöÂåñÂ≠¶ËßÜÈ¢ë
            'bio_bbc': '2026-02-15',           // ÈÄâÂÅöÔºöBBCÁ∫™ÂΩïÁâá
            'econ_case': '2026-02-15',         // ÈÄâÂÅöÔºöÁªèÊµéÊ°à‰æã
            'cn_extra_read': '2026-02-16',     // ÈÄâÂÅöÔºö‰∏≠ÊñáÊãìÂ±ï
            'geo_questionnaire': '2026-02-16', // ÈÄâÂÅöÔºöÂú∞ÁêÜÈóÆÂç∑
        };

        // Âä†ËΩΩ‰ªªÂä°ÂàÜÈÖçÔºà‰ºòÂÖàÁî®Êà∑‰øùÂ≠òÁöÑÔºåÂê¶ÂàôÁî®È¢ÑËÆæÔºâ
        const savedAssignments = localStorage.getItem('homework_assignments');
        if (savedAssignments) {
            try {
                taskAssignments = JSON.parse(savedAssignments);
            } catch(e) {
                taskAssignments = { ...defaultAssignments };
            }
        } else {
            // È¶ñÊ¨°‰ΩøÁî®ÔºåÂä†ËΩΩÈ¢ÑËÆæËÆ°Âàí
            taskAssignments = { ...defaultAssignments };
            localStorage.setItem('homework_assignments', JSON.stringify(taskAssignments));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function changeWeek(delta) {
            currentWeekOffset += delta;
            if (currentWeekOffset < 0) currentWeekOffset = 0;
            if (currentWeekOffset > 3) currentWeekOffset = 3;
            renderDayView();
        }

        function renderDayView() {
            const container = document.getElementById('dayContainer');
            container.innerHTML = '';

            // Êõ¥Êñ∞Âë®Ê†áÁ≠æ
            document.getElementById('currentWeekLabel').textContent = `Á¨¨ ${currentWeekOffset + 1} Âë®`;

            // ËÆ°ÁÆóÂΩìÂâçÂë®ÁöÑÊó•ÊúüËåÉÂõ¥
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() + currentWeekOffset * 7);

            const today = formatDate(new Date());

            // Ê∏≤Êüì7Â§©
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const dateStr = formatDate(date);
                const isToday = dateStr === today;

                const dayTasks = tasks.filter(t => taskAssignments[t.id] === dateStr);

                const card = document.createElement('div');
                card.className = `day-card ${isToday ? 'today' : ''} ${selectedTaskId ? 'can-drop' : ''}`;
                card.dataset.date = dateStr;
                // ÁÇπÂáªÊó•ÊúüÂç°ÁâáÂèØ‰ª•ÂàÜÈÖçÈÄâ‰∏≠ÁöÑ‰ªªÂä°
                card.onclick = function(e) {
                    // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØ‰ªªÂä°Êú¨Ë∫´Ôºå‰∏çËß¶Âèë
                    if (e.target.closest('.day-task')) return;
                    handleDayClick(dateStr);
                };

                card.innerHTML = `
                    <div class="day-header">
                        <div class="day-date">${date.getDate()}</div>
                        <div class="day-weekday">Âë®${weekdays[date.getDay()]} ¬∑ ${date.getMonth() + 1}Êúà</div>
                    </div>
                    <div class="day-tasks" data-date="${dateStr}">
                        ${dayTasks.map(task => createDayTaskHTML(task)).join('')}
                    </div>
                `;

                container.appendChild(card);
            }

            // Ê∏≤ÊüìÂæÖÂàÜÈÖç‰ªªÂä°
            renderUnassignedTasks();

            // ËÆæÁΩÆÊãñÊãΩ
            setupDragAndDrop();
        }

        function createDayTaskHTML(task, showDetail = false) {
            const isCompleted = completedTasks.has(task.id);
            const isSelected = selectedTaskId === task.id;
            return `
                <div class="day-task ${isCompleted ? 'completed' : ''} ${isSelected ? 'selected' : ''} ${task.required ? '' : 'optional-task'}"
                     draggable="true"
                     data-task-id="${task.id}"
                     onclick="handleTaskClick(event, '${task.id}')"
                     title="${task.detail || ''}">
                    <span class="day-task-subject">${subjects[task.subject].icon}</span>
                    <span class="day-task-title">${task.title}</span>
                    <span class="day-task-tag ${task.required ? 'required' : 'optional'}">${task.required ? 'ÂøÖÂÅö' : 'ÈÄâÂÅö'}</span>
                </div>
            `;
        }

        // ÁÇπÂáª‰ªªÂä°ÔºöÁ¨¨‰∏ÄÊ¨°ÁÇπÂáªÈÄâ‰∏≠ÔºåÁ¨¨‰∫åÊ¨°ÁÇπÂáªÂÆåÊàê
        function handleTaskClick(event, taskId) {
            event.stopPropagation();
            if (selectedTaskId === taskId) {
                // Á¨¨‰∫åÊ¨°ÁÇπÂáªÔºåÂàáÊç¢ÂÆåÊàêÁä∂ÊÄÅ
                toggleTask(taskId);
                selectedTaskId = null;
            } else {
                // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÔºåÈÄâ‰∏≠‰ªªÂä°
                selectedTaskId = taskId;
                showTaskDetail(taskId);
            }
            renderDayView();
        }

        // ÊòæÁ§∫‰ªªÂä°ËØ¶ÊÉÖ
        function showTaskDetail(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ËØ¶ÊÉÖÂºπÁ™óÔºåÊöÇÊó∂Áî®titleÊòæÁ§∫
                console.log('ÈÄâ‰∏≠‰ªªÂä°:', task.title, '-', task.detail);
            }
        }

        // ÁÇπÂáªÊó•ÊúüÂç°ÁâáÂàÜÈÖçÈÄâ‰∏≠ÁöÑ‰ªªÂä°
        function handleDayClick(dateStr) {
            if (selectedTaskId) {
                taskAssignments[selectedTaskId] = dateStr;
                saveAssignments();
                selectedTaskId = null;
                renderDayView();
            }
        }

        function renderUnassignedTasks() {
            const container = document.getElementById('unassignedTasks');
            const unassigned = tasks.filter(t => !taskAssignments[t.id]);

            document.getElementById('unassignedCount').textContent = unassigned.length;

            container.innerHTML = unassigned.map(task => createDayTaskHTML(task)).join('');
        }

        function setupDragAndDrop() {
            // ËÆæÁΩÆÂèØÊãñÂä®ÁöÑ‰ªªÂä°
            document.querySelectorAll('.day-task').forEach(el => {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
            });

            // ËÆæÁΩÆÊîæÁΩÆÂå∫Âüü
            document.querySelectorAll('.day-tasks').forEach(el => {
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
            });

            // ÂæÖÂàÜÈÖçÂå∫Âüü‰πüÂèØ‰ª•Êé•Êî∂
            const unassigned = document.getElementById('unassignedTasks');
            unassigned.addEventListener('dragover', handleDragOver);
            unassigned.addEventListener('dragleave', handleDragLeave);
            unassigned.addEventListener('drop', handleDropUnassigned);
        }

        let draggedTaskId = null;

        function handleDragStart(e) {
            draggedTaskId = e.target.dataset.taskId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            const date = e.currentTarget.dataset.date;
            if (draggedTaskId && date) {
                taskAssignments[draggedTaskId] = date;
                saveAssignments();
                renderDayView();
            }
        }

        function handleDropUnassigned(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (draggedTaskId) {
                delete taskAssignments[draggedTaskId];
                saveAssignments();
                renderDayView();
            }
        }

        function saveAssignments() {
            localStorage.setItem('homework_assignments', JSON.stringify(taskAssignments));
        }

        // ‰øùÁïôÂéüÂáΩÊï∞ÂêçÂÖºÂÆπ
        function renderWeekView() {
            renderDayView();
        }

        // Render badges
        function renderBadges() {
            const container = document.getElementById('badgesRow');
            container.innerHTML = '';

            badges.forEach(badge => {
                const level = userStats.badges[badge.id] || 0;
                const levelClass = level === 0 ? 'locked' : ['', 'bronze', 'silver', 'gold'][level];
                const stars = level > 0 ? '‚≠ê'.repeat(level) : '';

                const el = document.createElement('div');
                el.className = `badge-mini ${levelClass}`;
                el.innerHTML = `${badge.icon}<span class="badge-stars">${stars}</span>`;
                el.title = `${badge.name}: ${level > 0 ? badge.desc[level - 1] : 'Êú™Ëß£ÈîÅ'}`;
                container.appendChild(el);
            });
        }

        // Update stats display
        function updateStats() {
            const totalCompleted = completedTasks.size;
            const percent = Math.round((totalCompleted / tasks.length) * 100);

            // Update progress ring
            const ring = document.getElementById('progressRing');
            const offset = 314 - (314 * percent / 100);
            ring.style.strokeDashoffset = offset;
            document.getElementById('totalPercent').textContent = percent + '%';

            // Update level
            let currentLevel = levels[0];
            for (const l of levels) {
                if (totalCompleted >= l.required) currentLevel = l;
            }
            document.getElementById('levelValue').textContent = currentLevel.level;
            document.getElementById('levelTitle').textContent = currentLevel.name;

            // Update streak
            document.getElementById('streakValue').textContent = userStats.streak_days;

            // Update completed count
            document.getElementById('completedValue').textContent = totalCompleted;
            document.getElementById('totalTasks').textContent = `/ ${tasks.length} È°π`;
        }

        // Update all UI
        function updateUI() {
            renderSubjectView();
            renderWeekView();
            renderBadges();
            updateStats();
        }

        // Setup view toggle
        function setupViewToggle() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const view = btn.dataset.view;
                    document.getElementById('subjectView').classList.toggle('active', view === 'subject');
                    document.getElementById('dayView').classList.toggle('active', view === 'day');
                    if (view === 'day') renderDayView();
                });
            });
        }

        // Start - Á´ãÂç≥Ê∏≤ÊüìÈ°µÈù¢
        renderSubjectView();
        renderWeekView();
        renderBadges();
        updateStats();
        setupViewToggle();

        // ‰ªélocalStorageÂä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑËøõÂ∫¶
        const savedProgress = localStorage.getItem('homework_progress');
        if (savedProgress) {
            try {
                completedTasks = new Set(JSON.parse(savedProgress));
                updateUI();
            } catch(e) {}
        }

        const savedStats = localStorage.getItem('homework_stats');
        if (savedStats) {
            try {
                userStats = JSON.parse(savedStats);
                updateStats();
                renderBadges();
            } catch(e) {}
        }

        // ÂºÇÊ≠•Âä†ËΩΩSupabaseÔºà‰∏çÈòªÂ°ûÈ°µÈù¢Ôºâ
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = function() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                loadProgress().then(() => {
                    updateUI();
                    setupRealtimeSync();
                });
                document.getElementById('syncText').textContent = 'ÂÆûÊó∂ÂêåÊ≠•‰∏≠';
            } catch(e) {
                document.getElementById('syncText').textContent = 'Êú¨Âú∞Ê®°Âºè';
            }
        };
        script.onerror = function() {
            document.getElementById('syncText').textContent = 'Êú¨Âú∞Ê®°Âºè';
        };
        document.body.appendChild(script);
    </script>
</body>
</html>
