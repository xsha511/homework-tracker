<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFÊü•ÁúãÂô® - ‰∏äÊµ∑Ëµ´Ë¥§Â≠¶Ê†°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --color-navy: #1a2a4a;
            --color-gold: #d4a441;
            --color-cream: #faf8f3;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, 'PingFang SC', sans-serif;
            background: #525659;
            min-height: 100vh;
        }

        /* È°∂ÈÉ®Â∑•ÂÖ∑Ê†è */
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--color-navy);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .doc-title {
            color: white;
            font-size: 16px;
            font-weight: 500;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .toolbar-center {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 6px;
        }

        .page-nav input {
            width: 50px;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }

        .page-nav span {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .zoom-level {
            color: white;
            font-size: 13px;
            min-width: 50px;
            text-align: center;
        }

        .download-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--color-gold);
            color: var(--color-navy);
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .download-btn:hover {
            background: #e5b84d;
        }

        /* PDFÂÆπÂô® */
        .pdf-container {
            padding-top: 56px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 40px;
        }

        .page-wrapper {
            margin: 20px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            background: white;
        }

        .page-wrapper canvas {
            display: block;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--color-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }

        .loading-progress {
            color: var(--color-gold);
            margin-top: 10px;
            font-size: 14px;
        }

        /* È°µÈù¢Âä†ËΩΩÊåáÁ§∫Âô® */
        .page-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            color: #666;
            font-size: 14px;
        }

        /* ÈîôËØØÁä∂ÊÄÅ */
        .error-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .error-container.hidden {
            display: none;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 20px;
            color: var(--color-navy);
            margin-bottom: 10px;
        }

        .error-message {
            color: #666;
            margin-bottom: 20px;
        }

        .error-btn {
            padding: 10px 24px;
            background: var(--color-navy);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .toolbar {
                padding: 0 10px;
            }

            .doc-title {
                display: none;
            }

            .download-btn span {
                display: none;
            }

            .zoom-level {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Âä†ËΩΩÈÅÆÁΩ© -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Ê≠£Âú®Âä†ËΩΩPDFÊñáÊ°£...</div>
        <div class="loading-progress" id="loadingProgress">ÂáÜÂ§á‰∏≠</div>
    </div>

    <!-- ÈîôËØØÊèêÁ§∫ -->
    <div class="error-container hidden" id="errorContainer">
        <div class="error-icon">üòï</div>
        <div class="error-title">Êó†Ê≥ïÂä†ËΩΩÊñáÊ°£</div>
        <div class="error-message" id="errorMessage">ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï</div>
        <button class="error-btn" onclick="location.reload()">ÈáçÊñ∞Âä†ËΩΩ</button>
    </div>

    <!-- Â∑•ÂÖ∑Ê†è -->
    <div class="toolbar">
        <div class="toolbar-left">
            <a href="index.html" class="back-btn">‚Üê ËøîÂõû</a>
            <div class="doc-title" id="docTitle">PDFÊñáÊ°£</div>
        </div>

        <div class="toolbar-center">
            <button class="nav-btn" id="prevBtn" title="‰∏ä‰∏ÄÈ°µ">‚Äπ</button>
            <div class="page-nav">
                <input type="number" id="pageInput" min="1" value="1">
                <span>/ <span id="totalPages">-</span></span>
            </div>
            <button class="nav-btn" id="nextBtn" title="‰∏ã‰∏ÄÈ°µ">‚Ä∫</button>
        </div>

        <div class="toolbar-right">
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomOut" title="Áº©Â∞è">‚àí</button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="zoom-btn" id="zoomIn" title="ÊîæÂ§ß">+</button>
            </div>
            <a class="download-btn" id="downloadBtn" title="‰∏ãËΩΩPDF">
                ‚Üì <span>‰∏ãËΩΩ</span>
            </a>
        </div>
    </div>

    <!-- PDFÂÆπÂô® -->
    <div class="pdf-container" id="pdfContainer"></div>

    <script>
        // ÈÖçÁΩÆPDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Ëé∑ÂèñURLÂèÇÊï∞
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('url');
        const title = urlParams.get('title') || 'PDFÊñáÊ°£';

        // Áä∂ÊÄÅÂèòÈáè
        let pdfDoc = null;
        let currentScale = 1.0;
        let renderedPages = new Set();
        let renderingPages = new Set();

        // DOMÂÖÉÁ¥†
        const container = document.getElementById('pdfContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingProgress = document.getElementById('loadingProgress');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const docTitle = document.getElementById('docTitle');
        const pageInput = document.getElementById('pageInput');
        const totalPagesSpan = document.getElementById('totalPages');
        const zoomLevel = document.getElementById('zoomLevel');
        const downloadBtn = document.getElementById('downloadBtn');

        // ÂàùÂßãÂåñ
        docTitle.textContent = decodeURIComponent(title);
        document.title = decodeURIComponent(title) + ' - PDFÊü•ÁúãÂô®';

        if (!pdfUrl) {
            showError('Êú™ÊåáÂÆöPDFÊñá‰ª∂');
        } else {
            downloadBtn.href = pdfUrl;
            downloadBtn.download = title + '.pdf';
            loadPDF(pdfUrl);
        }

        // Âä†ËΩΩPDF
        async function loadPDF(url) {
            try {
                const loadingTask = pdfjsLib.getDocument({
                    url: url,
                    rangeChunkSize: 65536,
                    disableAutoFetch: true,
                    disableStream: false
                });

                loadingTask.onProgress = function(progress) {
                    if (progress.total > 0) {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        loadingProgress.textContent = `Âä†ËΩΩ‰∏≠ ${percent}%`;
                    } else {
                        loadingProgress.textContent = `Â∑≤Âä†ËΩΩ ${Math.round(progress.loaded / 1024)} KB`;
                    }
                };

                pdfDoc = await loadingTask.promise;
                totalPagesSpan.textContent = pdfDoc.numPages;
                pageInput.max = pdfDoc.numPages;

                // Âè™Ëé∑ÂèñÁ¨¨‰∏ÄÈ°µÁöÑÂ∞∫ÂØ∏ÔºåÁî®‰∫é‰º∞ÁÆóÂÖ∂‰ªñÈ°µÈù¢
                const firstPage = await pdfDoc.getPage(1);
                defaultViewport = firstPage.getViewport({ scale: currentScale });

                // Áî®Áªü‰∏ÄÂ∞∫ÂØ∏ÂàõÂª∫Âç†‰ΩçÁ¨¶Ôºà‰∏çËé∑ÂèñÊØèÈ°µÁöÑÂÆûÈôÖÂ∞∫ÂØ∏Ôºâ
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    createPagePlaceholder(i);
                }

                loadingOverlay.classList.add('hidden');

                // Á´ãÂç≥Ê∏≤ÊüìÁ¨¨‰∏ÄÈ°µ
                await renderPage(1);

                // ÁõëÂê¨ÊªöÂä®‰ª•ÊáíÂä†ËΩΩ
                window.addEventListener('scroll', debounce(renderVisiblePages, 100));
                window.addEventListener('resize', debounce(handleResize, 200));

            } catch (error) {
                console.error('PDFÂä†ËΩΩÈîôËØØ:', error);
                showError(error.message || 'Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
            }
        }

        // ÈªòËÆ§ËßÜÂè£Â∞∫ÂØ∏
        let defaultViewport = null;

        // ÂàõÂª∫È°µÈù¢Âç†‰ΩçÁ¨¶Ôºà‰∏çÂä†ËΩΩÈ°µÈù¢Êï∞ÊçÆÔºâ
        function createPagePlaceholder(pageNum) {
            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper';
            wrapper.id = `page-${pageNum}`;
            wrapper.style.width = defaultViewport.width + 'px';
            wrapper.style.height = defaultViewport.height + 'px';
            wrapper.dataset.pageNum = pageNum;

            wrapper.innerHTML = `<div class="page-loading" style="width:${defaultViewport.width}px;height:${defaultViewport.height}px;">Á¨¨ ${pageNum} È°µ</div>`;

            container.appendChild(wrapper);
        }

        // Ê∏≤ÊüìÂèØËßÅÈ°µÈù¢
        function renderVisiblePages() {
            const wrappers = document.querySelectorAll('.page-wrapper');
            const viewportTop = window.scrollY - 500; // È¢ÑÂä†ËΩΩ‰∏äÊñπ500px
            const viewportBottom = window.scrollY + window.innerHeight + 500; // È¢ÑÂä†ËΩΩ‰∏ãÊñπ500px

            wrappers.forEach(wrapper => {
                const rect = wrapper.getBoundingClientRect();
                const pageTop = rect.top + window.scrollY;
                const pageBottom = pageTop + rect.height;
                const pageNum = parseInt(wrapper.dataset.pageNum);

                // Ê£ÄÊü•È°µÈù¢ÊòØÂê¶Âú®ÂèØËßÅËåÉÂõ¥ÂÜÖ
                if (pageBottom >= viewportTop && pageTop <= viewportBottom) {
                    if (!renderedPages.has(pageNum) && !renderingPages.has(pageNum)) {
                        renderPage(pageNum);
                    }
                }
            });

            // Êõ¥Êñ∞ÂΩìÂâçÈ°µÁ†Å
            updateCurrentPage();
        }

        // Ê∏≤ÊüìÂçï‰∏™È°µÈù¢
        async function renderPage(pageNum) {
            if (renderingPages.has(pageNum)) return;
            renderingPages.add(pageNum);

            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: currentScale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                // È´òDPIÊîØÊåÅ
                const pixelRatio = window.devicePixelRatio || 1;
                canvas.width = viewport.width * pixelRatio;
                canvas.height = viewport.height * pixelRatio;
                canvas.style.width = viewport.width + 'px';
                canvas.style.height = viewport.height + 'px';
                context.scale(pixelRatio, pixelRatio);

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                const wrapper = document.getElementById(`page-${pageNum}`);
                wrapper.innerHTML = '';
                wrapper.appendChild(canvas);

                renderedPages.add(pageNum);
            } catch (error) {
                console.error(`Ê∏≤ÊüìÁ¨¨${pageNum}È°µÂ§±Ë¥•:`, error);
            } finally {
                renderingPages.delete(pageNum);
            }
        }

        // Êõ¥Êñ∞ÂΩìÂâçÈ°µÁ†Å
        function updateCurrentPage() {
            const wrappers = document.querySelectorAll('.page-wrapper');
            const viewportMiddle = window.scrollY + window.innerHeight / 2;

            for (const wrapper of wrappers) {
                const rect = wrapper.getBoundingClientRect();
                const pageTop = rect.top + window.scrollY;
                const pageBottom = pageTop + rect.height;

                if (pageTop <= viewportMiddle && pageBottom >= viewportMiddle) {
                    pageInput.value = wrapper.dataset.pageNum;
                    break;
                }
            }
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µ
        function goToPage(pageNum) {
            pageNum = Math.max(1, Math.min(pageNum, pdfDoc.numPages));
            const wrapper = document.getElementById(`page-${pageNum}`);
            if (wrapper) {
                wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                pageInput.value = pageNum;
            }
        }

        // Áº©Êîæ
        async function setScale(newScale) {
            newScale = Math.max(0.5, Math.min(3, newScale));
            currentScale = newScale;
            zoomLevel.textContent = Math.round(newScale * 100) + '%';

            // ËÆ∞‰ΩèÂΩìÂâçÈ°µ
            const currentPage = parseInt(pageInput.value);

            // Ê∏ÖÈô§Â∑≤Ê∏≤ÊüìÁöÑÈ°µÈù¢
            renderedPages.clear();
            container.innerHTML = '';

            // ÈáçÊñ∞ÂàõÂª∫Âç†‰ΩçÁ¨¶
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                await createPagePlaceholder(i);
            }

            // Ë∑≥ÂõûÂΩìÂâçÈ°µ
            goToPage(currentPage);
            renderVisiblePages();
        }

        // Â§ÑÁêÜÁ™óÂè£Â§ßÂ∞èÂèòÂåñ
        function handleResize() {
            renderVisiblePages();
        }

        // ÊòæÁ§∫ÈîôËØØ
        function showError(message) {
            loadingOverlay.classList.add('hidden');
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        // Èò≤ÊäñÂáΩÊï∞
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        document.getElementById('prevBtn').addEventListener('click', () => {
            goToPage(parseInt(pageInput.value) - 1);
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            goToPage(parseInt(pageInput.value) + 1);
        });

        pageInput.addEventListener('change', () => {
            goToPage(parseInt(pageInput.value));
        });

        pageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                goToPage(parseInt(pageInput.value));
            }
        });

        document.getElementById('zoomIn').addEventListener('click', () => {
            setScale(currentScale + 0.25);
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            setScale(currentScale - 0.25);
        });

        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            switch(e.key) {
                case 'ArrowLeft':
                case 'PageUp':
                    goToPage(parseInt(pageInput.value) - 1);
                    break;
                case 'ArrowRight':
                case 'PageDown':
                    goToPage(parseInt(pageInput.value) + 1);
                    break;
                case '+':
                case '=':
                    setScale(currentScale + 0.25);
                    break;
                case '-':
                    setScale(currentScale - 0.25);
                    break;
                case 'Home':
                    goToPage(1);
                    break;
                case 'End':
                    goToPage(pdfDoc.numPages);
                    break;
            }
        });
    </script>
</body>
</html>
